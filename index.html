<!DOCTYPE html>
<html lang="uk">
<head> 
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>AI Assistant</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;500;800;900&display=swap" rel="stylesheet">
<!-- Load Transformers.js -->
<script src="https://cdn.jsdelivr.net/npm/@xenova/transformers@2.6.0"></script>
<!-- Load Lucide Icons -->
<script src="https://unpkg.com/lucide@latest"></script>
<!-- Load QRCode.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>


<style>
    /* BASIC RESET & FONTS */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Montserrat', sans-serif;
    }
    body {
        background-color: transparent; /* Allows embedding on other pages easily */
    }


    /* CHAT CONTAINER STYLES */
    .chat-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 500px;
        height: 500px;
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        display: none; /* Hidden by default */
        flex-direction: column;
        z-index: 1001;
        transition: all 0.3s ease;
    }


    /* HEADER */
    .chat-header {
        background-color: #202123;
        color: #fff;
        padding: 12px 15px;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
        text-align: center;
        position: relative;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    .header-title {
        font-size: 18px;
        font-weight: 600;
        line-height: 1.2;
    }
    .header-subtitle {
        font-size: 11px;
        font-weight: 400;
        opacity: 0.9;
        margin-top: 4px;
        color: #ddd;
        line-height: 1.4;
        min-height: 15px; /* Prevent jump */
    }
    
    .close-chat-button {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        color: white;
        font-size: 28px;
        cursor: pointer;
        line-height: 1;
        padding: 0 5px;
    }
    .close-chat-button:hover {
        color: #ccc;
    }


    /* HISTORY & MESSAGES */
    .chat-history {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        border-bottom: 1px solid #e5e5e5;
    }
    .message {
        margin-bottom: 15px;
        display: flex;
        flex-direction: column;
    }
    .message.user {
        align-items: flex-end;
    }
    .message.bot {
        align-items: flex-start;
    }
    .message-text {
        max-width: 70%;
        padding: 10px 15px;
        border-radius: 10px;
        word-wrap: break-word;
        font-size: 14px;
        position: relative;
    }
    .message.user .message-text {
        background-color: #007bff;
        color: #fff;
    }
    .message.bot .message-text {
        background-color: #e5e5e5;
        color: #000;
    }
    
    /* Link Styling in Bot Messages */
    .message.bot .message-text a {
        color: #0056b3;
        text-decoration: underline;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    .message.bot .message-text a:hover {
        color: #003d82;
    }
    
    /* Active Link Highlight (when QR is shown) */
    .message.bot .message-text a.qr-highlight {
        background-color: rgba(0, 0, 0, 0.1);
        color: #000;
        font-weight: 800;
        text-decoration: none;
        padding: 0 4px;
        border-radius: 4px;
        border: 1px solid #999;
    }


    /* QR CONTAINER STYLES */
    .qr-wrapper {
        margin-top: 10px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #eee;
        display: none; /* Hidden by default */
        flex-direction: column;
        align-items: center;
        width: 100%;
        max-width: 200px;
        align-self: flex-start;
    }
    .qr-display {
        background: white;
        padding: 5px;
        border-radius: 4px;
    }
    .qr-controls {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        margin-top: 8px;
        width: 100%;
    }
    .qr-nav-btn {
        background: none;
        border: 1px solid #ddd;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: #555;
    }
    .qr-nav-btn:hover:not(:disabled) {
        background-color: #e2e2e2;
        color: #000;
    }
    .qr-nav-btn:disabled {
        opacity: 0.3;
        cursor: default;
    }
    .qr-counter {
        font-size: 10px;
        color: #888;
        font-weight: 500;
    }


    /* ACTIONS CONTAINER (Copy + QR buttons) */
    .message-actions {
        margin-top: 6px;
        margin-left: 2px;
        opacity: 0; /* Hidden initially, fades in via JS */
        transition: opacity 0.3s ease;
        display: flex; 
        gap: 10px; /* Space between buttons */
    }


    /* COMMON BUTTON STYLES */
    .action-button {
        background: transparent;
        border: none;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: background-color 0.2s ease;
    }
    .action-button:hover {
        background-color: #f0f0f0;
    }
    .action-button .lucide {
        width: 14px;
        height: 14px;
        color: #888;
        transition: color 0.2s ease;
    }
    .action-text {
        font-size: 11px;
        color: #ccc;
        font-weight: 500;
        user-select: none;
        transition: color 0.2s ease;
    }
    .action-button:hover .action-text {
        color: #888;
    }
    .action-button:hover .lucide {
        color: #333;
    }


    /* REDIRECT BUTTONS (YES/NO) */
    .redirect-container {
        margin-top: 10px;
        margin-left: 2px;
        display: flex;
        gap: 10px;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    .redirect-btn {
        padding: 6px 16px;
        border-radius: 5px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        transition: transform 0.1s ease, background-color 0.2s ease;
    }
    .redirect-btn:active {
        transform: scale(0.95);
    }
    .yes-btn {
        background-color: #007bff;
        color: white;
    }
    .yes-btn:hover {
        background-color: #0069d9;
    }
    .no-btn {
        background-color: #e5e5e5;
        color: #333;
    }
    .no-btn:hover {
        background-color: #d6d6d6;
    }


    /* INPUT AREA */
    .chat-input-container {
        display: flex;
        padding: 15px;
        gap: 8px;
        border-top: 1px solid #e5e5e5;
    }
    .chat-input {
        flex: 1;
        padding: 10px;
        font-size: 14px;
        border: 1px solid #e5e5e5;
        border-radius: 5px;
        outline: none;
    }
    .chat-input:focus {
        border-color: #007bff;
    }
    .chat-input::placeholder {
        opacity: 1;
        transition: opacity 0.3s ease-in-out;
    }
    .chat-input:disabled::placeholder {
        opacity: 0;
    }
    .send-button {
        padding: 0;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background-color: #007bff;
        color: #fff;
        border: none;
        cursor: pointer;
        font-size: 16px;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .send-button:disabled {
        background-color: #ccc;
        cursor: default;
    }


    /* TOGGLE BUTTON STYLES */
    .chat-toggle-button {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 70px;
        height: 70px;
        background-color: #007bff;
        border-radius: 50%;
        box-shadow: 3px 3px 4px rgba(0, 0, 0, 0.3);
        display: flex;
        justify-content: center;
        align-items: center;
        border: none;
        cursor: pointer;
        z-index: 1000;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
        outline: none;
        padding: 15px;
        margin: 0;
        -webkit-user-select: none;
        user-select: none;
        color: white;


        /* INITIAL STATE: Fully Visible */
        opacity: 1;
        /* TRANSITION: Standard transitions for transforms/shadows */
        transition: transform 0.4s ease-in-out, box-shadow 0.4s ease-in-out, opacity 0.4s ease-in-out;
    }


    /* IDLE STATE: Applied after 10 seconds via JS */
    .chat-toggle-button.inactive {
        opacity: 0.25; /* Barely visible */
        /* TRANSITION: Slow fade out (2s) when entering this state */
        transition: opacity 2s ease-out, transform 0.4s ease-in-out, box-shadow 0.4s ease-in-out;
    }


    /* HOVER STATE: High attention */
    .chat-toggle-button:hover {
        width: 65px;
        height: 65px;
        box-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        
        /* Force full visibility on hover */
        opacity: 1;
        
        /* TRANSITION: Fast fade in (0.3s) when hovering */
        transition: opacity 0.3s ease-in-out, width 0.4s ease-in-out, height 0.4s ease-in-out;
    }


    .chat-toggle-button::after {
        content: '';
        position: absolute;
        top: -15px;
        left: -15px;
        right: -15px;
        bottom: -15px;
    }


    /* Style for Lucide Icon inside button */
    .chat-toggle-button .lucide {
        width: 36px;
        height: 36px;
        stroke: currentColor;
    }


    /* LOADER */
    .loader {
        display: none; /* Controlled by JS */
    }


    /* RESPONSIVE STYLES */
    @media (max-aspect-ratio: 1/1), (max-width: 638px) {
        .chat-container {
            width: calc(100% - 20px); 
            height: 80vh; 
            right: 10px; 
            left: 10px; 
            bottom: 20px; 
            margin: 0 auto; 
            box-sizing: border-box;
        }
        .chat-toggle-button {
            left: calc(100% - 60px - 20px); 
            width: 60px; 
            height: 60px; 
            bottom: 20px;
        }
    }
</style>
</head>
<body>


    <!-- CHAT INTERFACE -->
    <div class="chat-container">
        <div class="chat-header">
            <div class="header-title">–ê–Ü - –ø–æ—à—É–∫</div>
            <div class="header-subtitle" id="headerStatus">–ó'—î–¥–Ω–∞–Ω–Ω—è...</div>
            <button class="close-chat-button">√ó</button>
        </div>
        <div class="chat-history" id="chatHistory">
            <div class="message bot">
                <div class="message-text">–Ñ –ø–∏—Ç–∞–Ω–Ω—è, –∞ —à—É–∫–∞—Ç–∏ –Ω–µ –≥–æ—Ç–æ–≤—ñ? üîç<br>–ú–æ–∂–µ—Ç–µ –∑–∞–ø–∏—Ç–∞—Ç–∏ —Ç—É—Ç! üß†<br><br><b>–ó–≤–µ—Ä—Ç–∞—é –í–∞—à—É —É–≤–∞–≥—É:</b><br>–û–¥–∏–Ω –∑–∞–ø–∏—Ç - –æ–¥–Ω–µ –ø–∏—Ç–∞–Ω–Ω—è üìå<br>–Ü–Ω–∫–æ–ª–∏ —è –º–æ–∂—É –ø–æ–º–∏–ª—è—Ç–∏—Å—è üß©<br><br>–ê–ª–µ —è –±—É–¥—É —Ä–∞–¥–∏–π –¥–æ–ø–æ–º–æ–≥—Ç–∏!</div>
            </div>
        </div>
        <div class="chat-input-container">
            <!-- Disabled by default, enabled via JS when AI loads -->
            <input type="text" class="chat-input" id="inputText" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –í–∞—à –∑–∞–ø–∏—Ç..." disabled>
            <button class="send-button" onclick="sendMessage()" disabled>‚û§</button>
        </div>
    </div>


    <!-- TOGGLE BUTTON -->
    <button class="chat-toggle-button">
        <i data-lucide="bot"></i>
    </button>


<script>
// AI CHAT VARIABLES
let isProcessing=false, pipe=null, embeddingsLoading=false, animationInterval=null;


// Error & State Flags
let isPartialLoad = false;  // True if external DB failed, using internal
let isCriticalError = false; // True if Embeddings/AI failed completely


// Data Storage
let answers = []; 
let urlCategories = {
    'NDCH_NEW': [],
    'NDCH_OLD': [],
    'YOUTUBE': [],
    'KNU_MAIN': [],
    'CONTACTS': [],
    'EXTERNAL': [],
    'RESEARCH_CENTERS': [] // Added specifically for –¶–ö–ö–ù–û
};


// Category Descriptors
const categoryDescriptors = {
    'NDCH_NEW': "–ù–æ–≤–∏–π —Å–∞–π—Ç, –∞–∫—Ç—É–∞–ª—å–Ω—ñ –Ω–æ–≤–∏–Ω–∏, —â–æ –Ω–æ–≤–æ–≥–æ, –ø–æ—Ç–æ—á–Ω—ñ –ø–æ–¥—ñ—ó. –ö–æ–Ω–∫—É—Ä—Å–∏, –≥—Ä–∞–Ω—Ç–∏, —Å—Ç–∏–ø–µ–Ω–¥—ñ—ó, –ø—Ä–µ–º—ñ—ó, —Ñ—ñ–Ω–∞–Ω—Å—É–≤–∞–Ω–Ω—è. –ù–∞–∫–∞–∑–∏, —Ä–æ–∑–ø–æ—Ä—è–¥–∂–µ–Ω–Ω—è, –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω–∞ –±–∞–∑–∞, –¥–æ–∫—É–º–µ–Ω—Ç–∏. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞—É–∫–æ–≤–æ—ó —á–∞—Å—Ç–∏–Ω–∏, –≤—ñ–¥–¥—ñ–ª–∏, –∫–µ—Ä—ñ–≤–Ω–∏—Ü—Ç–≤–æ, –Ω–∞—É–∫–∞ —Å—å–æ–≥–æ–¥–Ω—ñ. –û–≥–æ–ª–æ—à–µ–Ω–Ω—è, –ø—Ä–æ—î–∫—Ç–∏, –º–æ–ª–æ–¥—ñ –≤—á–µ–Ω—ñ, –Ω–∞—É–∫–æ–≤–∞ –¥—ñ—è–ª—å–Ω—ñ—Å—Ç—å, –∑–≤—ñ—Ç–∏ –∑–∞ –ø–æ—Ç–æ—á–Ω–∏–π —Ä—ñ–∫. science.knu.ua.",
    
    'NDCH_OLD': "–°—Ç–∞—Ä–∏–π —Å–∞–π—Ç, –∞—Ä—Ö—ñ–≤, —ñ—Å—Ç–æ—Ä—ñ—è, —è–∫ –±—É–ª–æ —Ä–∞–Ω—ñ—à–µ, –º–∏–Ω—É–ª—ñ —Ä–æ–∫–∏. –ó–Ω–∞–π—Ç–∏ —Å—Ç–∞—Ä–∏–π –Ω–∞–∫–∞–∑, –∞—Ä—Ö—ñ–≤–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏, —Ä–æ–∑–ø–æ—Ä—è–¥–∂–µ–Ω–Ω—è –¥–æ 2023 —Ä–æ–∫—É. –§—ñ–Ω–∞–Ω—Å–æ–≤—ñ –∑–≤—ñ—Ç–∏ –º–∏–Ω—É–ª–∏—Ö –ø–µ—Ä—ñ–æ–¥—ñ–≤, –∞—Ä—Ö—ñ–≤ –±—É—Ö–≥–∞–ª—Ç–µ—Ä—ñ—ó, —Å—Ç–∞—Ä—ñ –∫–æ—à—Ç–æ—Ä–∏—Å–∏. –ë–∞–∑–∞ –¥–∞–Ω–∏—Ö –∑–∞ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ —Ä–æ–∫–∏, –≤—Ç—Ä–∞—Ç–∏–ª–∏ —á–∏–Ω–Ω—ñ—Å—Ç—å, —ñ—Å—Ç–æ—Ä—ñ—è –ø–∏—Ç–∞–Ω–Ω—è, —Ä–µ—Ç—Ä–æ—Å–ø–µ–∫—Ç–∏–≤–∞.",
    
    'YOUTUBE': "–í—ñ–¥–µ–æ, —é—Ç—É–±, YouTube, –¥–∏–≤–∏—Ç–∏—Å—å, –≥–ª—è–Ω—É—Ç–∏, –ø–æ–¥–∏–≤–∏—Ç–∏—Å—è, –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏, –≤—ñ–¥–µ–æ–∑–∞–ø–∏—Å–∏, —Ä–æ–ª–∏–∫, –≤—ñ–¥–æ—Å. –í–µ–±—ñ–Ω–∞—Ä–∏, —Å–µ–º—ñ–Ω–∞—Ä–∏, –ª–µ–∫—Ü—ñ—ó, –∑–∞–ø–∏—Å–∏ –∑—É—Å—Ç—Ä—ñ—á–µ–π, —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—ó, —Å—Ç—Ä—ñ–º–∏, –ø—Ä—è–º–∏–π –µ—Ñ—ñ—Ä. –ö–∞–Ω–∞–ª–∏, –º–µ–¥—ñ–∞, –Ω–∞—É–∫–æ–≤–æ-–ø–æ–ø—É–ª—è—Ä–Ω–µ, —ñ–Ω—Ç–µ—Ä–≤'—é, –≤—ñ–¥–µ–æ–∑–≤—ñ—Ç–∏, –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è. –©–æ –∑–Ω—ñ–º–∞—é—Ç—å, –¥–µ –ø–æ–¥–∏–≤–∏—Ç–∏—Å—è, –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –≤—ñ–¥–µ–æ, –∫–∞–Ω–∞–ª —Ä–∞–¥–∏ –º–æ–ª–æ–¥–∏—Ö –≤—á–µ–Ω–∏—Ö.",
    
    'KNU_MAIN': "–ì–æ–ª–æ–≤–Ω–∏–π —Å–∞–π—Ç —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç—É, –ö–ù–£, –∑–∞–≥–∞–ª—å–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è. –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ü—ñ—è, —Ä–µ–∫—Ç–æ—Ä–∞—Ç, –∫–µ—Ä—ñ–≤–Ω–∏—Ü—Ç–≤–æ, —Ä–µ–∫—Ç–æ—Ä, –ø—Ä–æ—Ä–µ–∫—Ç–æ—Ä–∏, —Ö—Ç–æ –≥–æ–ª–æ–≤–Ω–∏–π. –í—Å—Ç—É–ø, –∞–±—ñ—Ç—É—Ä—ñ—î–Ω—Ç, –Ω–∞–≤—á–∞–Ω–Ω—è, –æ—Å–≤—ñ—Ç–∞, —Ñ–∞–∫—É–ª—å—Ç–µ—Ç–∏, —ñ–Ω—Å—Ç–∏—Ç—É—Ç–∏, –∫–∞—Ñ–µ–¥—Ä–∏. –†–æ–∑–∫–ª–∞–¥, –∫–∞–ª–µ–Ω–¥–∞—Ä –ø–æ–¥—ñ–π, —Å—Ç—É–¥–µ–Ω—Ç—Å—å–∫–µ –∂–∏—Ç—Ç—è, –≥—É—Ä—Ç–æ–∂–∏—Ç–∫–∏, –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞. –ù–æ–≤–∏–Ω–∏ —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç—É, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, –æ—Ñ—ñ—Ü—ñ–π–Ω–æ.",
    
    'CONTACTS': "–ö–æ–Ω—Ç–∞–∫—Ç–∏, —Ç–µ–ª–µ—Ñ–æ–Ω, –Ω–æ–º–µ—Ä, –ø–æ–¥–∑–≤–æ–Ω–∏—Ç–∏, –Ω–∞–±—Ä–∞—Ç–∏, –∑–≤'—è–∑–æ–∫. –ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞ –ø–æ—à—Ç–∞, e-mail, –Ω–∞–ø–∏—Å–∞—Ç–∏ –ª–∏—Å—Ç–∞, –∞–¥—Ä–µ—Å–∞, –¥–µ –∑–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è, –∫–∞–±—ñ–Ω–µ—Ç, –∫–æ—Ä–ø—É—Å, –ª–æ–∫–∞—Ü—ñ—è. –î–æ–≤—ñ–¥–Ω–∏–∫, —è–∫ –∑–≤'—è–∑–∞—Ç–∏—Å—è, —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∏, –≤—ñ–¥–¥—ñ–ª –∫–∞–¥—Ä—ñ–≤, –±—É—Ö–≥–∞–ª—Ç–µ—Ä—ñ—è, –ø–ª–∞–Ω–æ–≤–∏–π –≤—ñ–¥–¥—ñ–ª. –ü—Ä—ñ–∑–≤–∏—â–∞, —ñ–º–µ–Ω–∞, –∫–æ–Ω—Ç–∞–∫—Ç–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—É, –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è.",
    
    'EXTERNAL': "–ó–æ–≤–Ω—ñ—à–Ω—ñ —Ä–µ—Å—É—Ä—Å–∏, —ñ–Ω—à—ñ —Å–∞–π—Ç–∏, –ø–∞—Ä—Ç–Ω–µ—Ä–∏, –º—ñ–Ω—ñ—Å—Ç–µ—Ä—Å—Ç–≤–∞. –ú—ñ–Ω—ñ—Å—Ç–µ—Ä—Å—Ç–≤–æ –æ—Å–≤—ñ—Ç–∏ —ñ –Ω–∞—É–∫–∏, –ú–û–ù, –ù–∞—Ü—ñ–æ–Ω–∞–ª—å–Ω–∏–π —Ñ–æ–Ω–¥ –¥–æ—Å–ª—ñ–¥–∂–µ–Ω—å, –ù–§–î–£. –ú—ñ–∂–Ω–∞—Ä–æ–¥–Ω—ñ –≥—Ä–∞–Ω—Ç–∏, —î–≤—Ä–æ–ø–µ–π—Å—å–∫—ñ –ø—Ä–æ–≥—Ä–∞–º–∏, Horizon Europe. –ù–∞—É–∫–æ–º–µ—Ç—Ä–∏—á–Ω—ñ –±–∞–∑–∏, Scopus, Web of Science, –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó –∑–∞ –∫–æ—Ä–¥–æ–Ω–æ–º, —Å—Ç–æ—Ä–æ–Ω–Ω—ñ –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—ó.",

    // Added explicit descriptor for –¶–ö–ö–ù–û so it wins against KNU_MAIN
    'RESEARCH_CENTERS': "–¶–ö–ö–ù–û, —Ü–µ–Ω—Ç—Ä–∏ –∫–æ–ª–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞–Ω–Ω—è, –Ω–∞—É–∫–æ–≤–µ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è, –ø—Ä–∏–ª–∞–¥–∏, –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—ó. –ö–æ—Å–º–æ—Å, –¥–æ—Å–ª—ñ–¥–∂–µ–Ω–Ω—è –∫–æ—Å–º–æ—Å—É, –∞—Å—Ç—Ä–æ–Ω–æ–º—ñ—è, —Ç–µ–ª–µ—Å–∫–æ–ø. –§—ñ–∑–∏–∫–∞, –±—ñ–æ–ª–æ–≥—ñ—è, –º–µ–¥–∏—Ü–∏–Ω–∞, –≥–µ–æ–ª–æ–≥—ñ—è, —Å–ø–µ–∫—Ç—Ä–æ—Å–∫–æ–ø—ñ—è. –£–Ω—ñ–∫–∞–ª—å–Ω–µ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è, –≤–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è, –∞–Ω–∞–ª—ñ–∑ —Ä–µ—á–æ–≤–∏–Ω–∏, –µ–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç, —ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞."
};


const categoryDisplayNames = {
    'NDCH_NEW': "–ù–æ–≤–∏–π —Å–∞–π—Ç –ù–î–ß",
    'NDCH_OLD': "–ê—Ä—Ö—ñ–≤ (–°—Ç–∞—Ä–∏–π —Å–∞–π—Ç)",
    'YOUTUBE': "YouTube (–í—ñ–¥–µ–æ)",
    'KNU_MAIN': "–ì–æ–ª–æ–≤–Ω–∏–π —Å–∞–π—Ç –ö–ù–£",
    'CONTACTS': "–ö–æ–Ω—Ç–∞–∫—Ç–∏ –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª—ñ–≤",
    'EXTERNAL': "–ó–æ–≤–Ω—ñ—à–Ω—ñ —Ä–µ—Å—É—Ä—Å–∏",
    'RESEARCH_CENTERS': "–ù–∞—É–∫–æ–≤—ñ —Ü–µ–Ω—Ç—Ä–∏ (–¶–ö–ö–ù–û)"
};


// Internal Backup Data
const internalRawData = `
–í–Ü–î–ü–û–í–Ü–î–Ü:
–í –æ—Å–Ω–æ–≤—ñ –º–æ—î—ó —Ä–æ–±–æ—Ç–∏ –ª–µ–∂–∞—Ç—å –µ–º–±–µ–¥—ñ–Ω–≥–∏ (embeddings). –Ü–∑ —ó—Ö –¥–æ–ø–æ–º–æ–≥–æ—é —è –∑–Ω–∞—Ö–æ–¥–∂—É –Ω–∞–π–±—ñ–ª—å—à –ø—ñ–¥—Ö–æ–¥—è—â—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å —Ç–∞ –∞–¥—Ä–µ—Å—É—é –í–∞–º
–ù–∞—É–∫–æ–≤–æ-–¥–æ—Å–ª—ñ–¥–Ω–∞ —á–∞—Å—Ç–∏–Ω–∞ (–ù–î–ß) –ö–∏—ó–≤—Å—å–∫–æ–≥–æ –Ω–∞—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ–≥–æ —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç—É —ñ–º–µ–Ω—ñ –¢–∞—Ä–∞—Å–∞ –®–µ–≤—á–µ–Ω–∫–∞ –∫–æ–æ—Ä–¥–∏–Ω—É—î –Ω–∞—É–∫–æ–≤—É, –Ω–∞—É–∫–æ–≤–æ-—Ç–µ—Ö–Ω—ñ—á–Ω—É —Ç–∞ —ñ–Ω–Ω–æ–≤–∞—Ü—ñ–π–Ω—É –¥—ñ—è–ª—å–Ω—ñ—Å—Ç—å.

–ù–û–í–ò–ô_–°–ê–ô–¢:
https://science.knu.ua/new/?page_id=4533: –ö–æ–Ω—Ç–∞–∫—Ç–∏ –ù–î–ß, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞—É–∫–æ–≤–æ—ó —á–∞—Å—Ç–∏–Ω–∏, —Ç–µ–ª–µ—Ñ–æ–Ω–∏ —Ç–∞ –∞–¥—Ä–µ—Å–∏ –≤—ñ–¥–¥—ñ–ª—ñ–≤, –∫–µ—Ä—ñ–≤–Ω–∏—Ü—Ç–≤–æ, —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∏
https://science.knu.ua/new/?page_id=4524: –ó–≤—ñ—Ç–∏ –ø—Ä–æ—Ä–µ–∫—Ç–æ—Ä–∞ –∑ –Ω–∞—É–∫–æ–≤–æ—ó —Ä–æ–±–æ—Ç–∏, —Ä—ñ—á–Ω—ñ –ø—ñ–¥—Å—É–º–∫–∏ –Ω–∞—É–∫–æ–≤–æ—ó –¥—ñ—è–ª—å–Ω–æ—Å—Ç—ñ, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—É–±–ª—ñ–∫–∞—Ü—ñ–π

–°–¢–ê–†–ò–ô_–°–ê–ô–¢:
https://science.knu.ua/old: –°—Ç–∞—Ä–∏–π —Å–∞–π—Ç –ù–î–ß, –∞—Ä—Ö—ñ–≤ –Ω–æ–≤–∏–Ω —Ç–∞ –ø–æ–¥—ñ–π, —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –¥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–æ—Ä—Ç–∞–ª—É
https://science.knu.ua/old/finance/index.html: –°—Ç–∞—Ä—ñ —Ñ—ñ–Ω–∞–Ω—Å–æ–≤—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏, –∞—Ä—Ö—ñ–≤ –±—É—Ö–≥–∞–ª—Ç–µ—Ä—ñ—ó, –∑—Ä–∞–∑–∫–∏ –∫–æ—à—Ç–æ—Ä–∏—Å—ñ–≤ –º–∏–Ω—É–ª–∏—Ö —Ä–æ–∫—ñ–≤

–¶–ö–ö–ù–û:
https://ccouse.knu.ua/: –¶–ö–ö–ù–û ¬´–ù–æ–≤—ñ—Ç–Ω—ñ –¥–æ—Å–ª—ñ–¥–Ω–∏—Ü—å–∫—ñ —Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó –≤ –±—ñ–æ–ª–æ–≥—ñ—ó —ñ –º–µ–¥–∏—Ü–∏–Ω—ñ¬ª, –±—ñ–æ–ª–æ–≥—ñ—á–Ω—ñ –¥–æ—Å–ª—ñ–¥–∂–µ–Ω–Ω—è, –º–µ–¥–∏—á–Ω–µ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è
https://geo.ccouse.knu.ua/: –¶–ö–ö–ù–û ¬´–°—É—á–∞—Å–Ω—ñ —Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó –¥–æ—Å–ª—ñ–¥–∂–µ–Ω–Ω—è —Ä–µ—á–æ–≤–∏–Ω–∏ –ó–µ–º–ª—ñ —Ç–∞ –°–æ–Ω—è—á–Ω–æ—ó —Å–∏—Å—Ç–µ–º–∏¬ª, –≥–µ–æ–ª–æ–≥—ñ—è, –º—ñ–Ω–µ—Ä–∞–ª–æ–≥—ñ—è
https://aomlab.phys.knu.ua/: –¶–ö–ö–ù–û ¬´–ú—ñ–∫—Ä–æ—Å–∫–æ–ø—ñ—è —Ç–∞ –ª–∞–∑–µ—Ä–Ω–∞ —Å–ø–µ–∫—Ç—Ä–æ—Å–∫–æ–ø—ñ—è¬ª, —Ñ—ñ–∑–∏—á–Ω—ñ –¥–æ—Å–ª—ñ–¥–∂–µ–Ω–Ω—è, –æ–ø—Ç–∏—á–Ω—ñ –º–µ—Ç–æ–¥–∏
https://virgoua.org/: –¶–ö–ö–ù–û ¬´–õ–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—è —Ñ—ñ–∑–∏–∫–∏ —Ç–∞ –∞—Å—Ç—Ä–æ—Ñ—ñ–∑–∏–∫–∏ –≤–∏—Å–æ–∫–∏—Ö –µ–Ω–µ—Ä–≥—ñ–π¬ª (–õ–§–ê–í–ï), —è–¥–µ—Ä–Ω–∞ —Ñ—ñ–∑–∏–∫–∞, –∞—Å—Ç—Ä–æ–Ω–æ–º—ñ—è, –∫–æ—Å–º–æ—Å

YOUTUBE:
https://www.youtube.com/@–†–∞–¥–∞–º–æ–ª–æ–¥–∏—Ö–≤—á–µ–Ω–∏—Ö–ö–ù–£–¢–®: –†–∞–¥–∞ –º–æ–ª–æ–¥–∏—Ö –≤—á–µ–Ω–∏—Ö (–†–ú–í), –≤–µ–±—ñ–Ω–∞—Ä–∏ –¥–ª—è –∞—Å–ø—ñ—Ä–∞–Ω—Ç—ñ–≤, —à–∫–æ–ª–∏ –º–æ–ª–æ–¥–∏—Ö –Ω–∞—É–∫–æ–≤—Ü—ñ–≤, –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü—ñ—ó, –≤—ñ–¥–µ–æ –∑–∞—Ö–æ–¥–∏
https://www.youtube.com/@naukaprostoknu: –ü—Ä–æ—î–∫—Ç #–ù–∞—É–∫–∞–ü—Ä–æ—Å—Ç–æ (NaukaProsto), –ø–æ–ø—É–ª—è—Ä–∏–∑–∞—Ü—ñ—è –Ω–∞—É–∫–∏, —ñ–Ω—Ç–µ—Ä–≤'—é –∑ –≤—á–µ–Ω–∏–º–∏, –ø—Ä–æ—Å—Ç–µ –ø–æ—è—Å–Ω–µ–Ω–Ω—è —Å–∫–ª–∞–¥–Ω–∏—Ö —è–≤–∏—â, –≤—ñ–¥–µ–æ

–ì–û–õ–û–í–ù–ò–ô_–°–ê–ô–¢:
https://knu.ua: –ì–æ–ª–æ–≤–Ω–∏–π –≤–µ–±-—Å–∞–π—Ç –£–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç—É –®–µ–≤—á–µ–Ω–∫–∞, –∑–∞–≥–∞–ª—å–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –≤—Å—Ç—É–ø, –Ω–∞–≤—á–∞–Ω–Ω—è —Ç–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—É
https://knu.ua/ua/knu-callendar: –ö–∞–ª–µ–Ω–¥–∞—Ä –ø–æ–¥—ñ–π –ö–ù–£, –≥—Ä–∞—Ñ—ñ–∫ –∑–∞—Ö–æ–¥—ñ–≤, –∞–Ω–æ–Ω—Å–∏ –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü—ñ–π —Ç–∞ –∑—É—Å—Ç—Ä—ñ—á–µ–π
https://knu.ua/ua/geninf/adm/: –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ü—ñ—è —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç—É, —Ä–µ–∫—Ç–æ—Ä–∞—Ç, –ø–µ—Ä–µ–ª—ñ–∫ –ø—Ä–æ—Ä–µ–∫—Ç–æ—Ä—ñ–≤ —Ç–∞ —ó—Ö –æ–±–æ–≤'—è–∑–∫–∏
https://knu.ua/ua/geninf/adm/Tolstanova/: –¢–æ–ª—Å—Ç–∞–Ω–æ–≤–∞ –ì–∞–Ω–Ω–∞ –ú–∏–∫–æ–ª–∞—ó–≤–Ω–∞, –ø—Ä–æ—Ä–µ–∫—Ç–æ—Ä –∑ –Ω–∞—É–∫–æ–≤–æ—ó —Ä–æ–±–æ—Ç–∏, –±—ñ–æ–≥—Ä–∞—Ñ—ñ—è, –ø—Ä–∏–π–æ–º–Ω—ñ –≥–æ–¥–∏–Ω–∏

–Ü–ù–®–Ü_–†–ï–°–£–†–°–ò:
https://asp.knu.ua/: –í—ñ–¥–¥—ñ–ª –∞—Å–ø—ñ—Ä–∞–Ω—Ç—É—Ä–∏ —Ç–∞ –¥–æ–∫—Ç–æ—Ä–∞–Ω—Ç—É—Ä–∏, –ø—Ä–∞–≤–∏–ª–∞ –≤—Å—Ç—É–ø—É, –ø—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –Ω–∞—É–∫–æ–≤–∏—Ö –∫–∞–¥—Ä—ñ–≤, –∑–∞—Ö–∏—Å—Ç –¥–∏—Å–µ—Ä—Ç–∞—Ü—ñ–π
https://library.knu.ua: –ù–∞—É–∫–æ–≤–∞ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ —ñ–º. –ú. –ú–∞–∫—Å–∏–º–æ–≤–∏—á–∞, –¥–æ—Å—Ç—É–ø –¥–æ –∫–Ω–∏–≥, –µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ñ —Ä–µ—Å—É—Ä—Å–∏, –±–∞–∑–∏ –¥–∞–Ω–∏—Ö
https://ir.library.knu.ua: –†–µ–ø–æ–∑–∏—Ç–∞—Ä—ñ–π eKNUTSHIR, –µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∏–π –∞—Ä—Ö—ñ–≤ –Ω–∞—É–∫–æ–≤–∏—Ö –ø—É–±–ª—ñ–∫–∞—Ü—ñ–π, —Å—Ç–∞—Ç—Ç—ñ, —Ç–µ–∑–∏, –¥–∏—Å–µ—Ä—Ç–∞—Ü—ñ—ó
https://scp.knu.ua/ua/: –ù–∞—É–∫–æ–≤–∏–π –ø–∞—Ä–∫ –ö–ù–£–¢–®, —ñ–Ω–Ω–æ–≤–∞—Ü—ñ–π–Ω–∞ –¥—ñ—è–ª—å–Ω—ñ—Å—Ç—å, –∫–æ–º–µ—Ä—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Ä–æ–∑—Ä–æ–±–æ–∫, —Å—Ç–∞—Ä—Ç–∞–ø–∏
http://diia-business-knu.com/: –î—ñ—è.–ë—ñ–∑–Ω–µ—Å –ö–ù–£, —Ü–µ–Ω—Ç—Ä –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ –ø—ñ–¥–ø—Ä–∏—î–º—Ü—ñ–≤, –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—ó, –±—ñ–∑–Ω–µ—Å-–æ—Å–≤—ñ—Ç–∞
https://lunoteka.knu.ua/: –õ—É–Ω–æ—Ç–µ–∫–∞ –ö–ù–£, —Å—Ç—É–¥–µ–Ω—Ç—Å—å–∫–∏–π –ø—Ä–æ—Å—Ç—ñ—Ä, –∫–æ–≤–æ—Ä–∫—ñ–Ω–≥, –º—ñ—Å—Ü–µ –¥–ª—è –Ω–∞–≤—á–∞–Ω–Ω—è —Ç–∞ –≤—ñ–¥–ø–æ—á–∏–Ω–∫—É
http://linktr.ee/business_school_knu: –ë—ñ–∑–Ω–µ—Å-—à–∫–æ–ª–∞ –ö–ù–£, –ø—Ä–æ–≥—Ä–∞–º–∏ MBA, —É–ø—Ä–∞–≤–ª—ñ–Ω—Å—å–∫–∞ –æ—Å–≤—ñ—Ç–∞, –∫—É—Ä—Å–∏
https://www.instagram.com/sfl_econom_knu/: –®–∫–æ–ª–∞ –ª—ñ–¥–µ—Ä—Å—Ç–≤–∞ —Ç–∞ –ø—ñ–¥–ø—Ä–∏—î–º–Ω–∏—Ü—Ç–≤–∞, –µ–∫–æ–Ω–æ–º—ñ—á–Ω–∏–π —Ñ–∞–∫—É–ª—å—Ç–µ—Ç, —Å—Ç—É–¥–µ–Ω—Ç—Å—å–∫—ñ —ñ–Ω—ñ—Ü—ñ–∞—Ç–∏–≤–∏
http://fb.com/groups/416391268735797: Robot&Electronic Laboratory, –ª–∞–±–æ—Ä–∞—Ç–æ—Ä—ñ—è —Ä–æ–±–æ—Ç–æ—Ç–µ—Ö–Ω—ñ–∫–∏ —Ç–∞ –µ–ª–µ–∫—Ç—Ä–æ–Ω—ñ–∫–∏, —ñ–Ω–∂–µ–Ω–µ—Ä–Ω—ñ –ø—Ä–æ—î–∫—Ç–∏
https://naukaprosto.knu.ua/: –°–∞–π—Ç –ø—Ä–æ—î–∫—Ç—É #–ù–∞—É–∫–∞–ü—Ä–æ—Å—Ç–æ, –Ω–∞—É–∫–æ–≤–æ-–ø–æ–ø—É–ª—è—Ä–Ω—ñ —Å—Ç–∞—Ç—Ç—ñ, –Ω–æ–≤–∏–Ω–∏ –Ω–∞—É–∫–∏ –≤ —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç—ñ

–ó–û–í–ù–Ü–®–ù–Ü:
https://ms.nauka.gov.ua/merezha-nkp/nkp-tsyfrovizatsiya-promyslovist-i-kosmos/: –ù–ö–ü "–¶–∏—Ñ—Ä–æ–≤—ñ–∑–∞—Ü—ñ—è, –ø—Ä–æ–º–∏—Å–ª–æ–≤—ñ—Å—Ç—å —ñ –∫–æ—Å–º–æ—Å", –ù–∞—Ü—ñ–æ–Ω–∞–ª—å–Ω–∏–π –∫–æ–Ω—Ç–∞–∫—Ç–Ω–∏–π –ø—É–Ω–∫—Ç Horizon Europe
`;


// INIT UI
document.addEventListener('DOMContentLoaded',()=>{
    lucide.createIcons();
    setTimeout(() => {
        const btn = document.querySelector('.chat-toggle-button');
        if(btn) btn.classList.add('inactive');
    }, 10000);
});


// PARSER
function parseDatabase(text) {
    answers = [];
    for(let key in urlCategories) urlCategories[key] = [];
    
    const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l.length > 0);
    let currentCategory = 'ANSWERS';
    
    for(const line of lines) {
        const upperLine = line.toUpperCase();
        if(upperLine.includes('–í–Ü–î–ü–û–í–Ü–î–Ü:')) { currentCategory = 'ANSWERS'; continue; }
        if(upperLine.includes('–ù–û–í–ò–ô_–°–ê–ô–¢:')) { currentCategory = 'NDCH_NEW'; continue; }
        if(upperLine.includes('–°–¢–ê–†–ò–ô_–°–ê–ô–¢:')) { currentCategory = 'NDCH_OLD'; continue; }
        // NEW: Detect RESEARCH_CENTERS / –¶–ö–ö–ù–û explicitly
        if(upperLine.includes('–¶–ö–ö–ù–û:') || upperLine.includes('RESEARCH_CENTERS:')) { currentCategory = 'RESEARCH_CENTERS'; continue; }
        if(upperLine.includes('YOUTUBE:')) { currentCategory = 'YOUTUBE'; continue; }
        if(upperLine.includes('–ì–û–õ–û–í–ù–ò–ô_–°–ê–ô–¢:') || upperLine.includes('KNU:')) { currentCategory = 'KNU_MAIN'; continue; }
        if(upperLine.includes('–ö–û–ù–¢–ê–ö–¢–ò:')) { currentCategory = 'CONTACTS'; continue; }
        if(upperLine.includes('–ó–û–í–ù–Ü–®–ù–Ü:') || upperLine.includes('–ó–û–í–ù–Ü–®–ù–Ü_–ü–û–°–ò–õ–ê–ù–ù–Ø:')) { currentCategory = 'EXTERNAL'; continue; }
        // Fix: Map "–Ü–ù–®–Ü_–†–ï–°–£–†–°–ò" to KNU_MAIN (where Lunoteka is)
        if(upperLine.includes('–Ü–ù–®–Ü_–†–ï–°–£–†–°–ò:') || upperLine.includes('OTHER_RESOURCES:')) { currentCategory = 'KNU_MAIN'; continue; }


        const cleanLine = line.replace(/^"|"$/g, '');


        if(currentCategory === 'ANSWERS') {
            answers.push(cleanLine);
        } else {
            let firstColonIndex = cleanLine.indexOf(':');
            if (firstColonIndex !== -1 && cleanLine.substring(firstColonIndex, firstColonIndex + 3) === '://') {
                firstColonIndex = cleanLine.indexOf(':', firstColonIndex + 3);
            }
            if(firstColonIndex !== -1) {
                const url = cleanLine.substring(0, firstColonIndex).trim();
                const ctx = cleanLine.substring(firstColonIndex + 1).trim();
                
                // Fix: Verify it is actually a URL
                if((url.toLowerCase().startsWith('http') || url.toLowerCase().startsWith('www')) && urlCategories[currentCategory]) {
                    urlCategories[currentCategory].push({ url: url, text: ctx });
                }
            }
        }
    }
}


function updateInputState() {
    const input = document.getElementById('inputText');
    if(isCriticalError) {
        input.placeholder = "–ü–æ–º–∏–ª–∫–∞ –®–Ü";
        input.disabled = false; 
    } else {
        input.placeholder = "–ù–∞–ø–∏—à—ñ—Ç—å –í–∞—à –∑–∞–ø–∏—Ç...";
        input.disabled = false;
    }
}


function updateHeaderStatus() {
    const el = document.getElementById('headerStatus');
    const disclaimer = "–®–Ü –º–æ–∂–µ –ø–æ–º–∏–ª—è—Ç–∏—Å—è. –ü–µ—Ä–µ–≤—ñ—Ä—è–π—Ç–µ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é.";
    
    if (isCriticalError) {
        el.innerHTML = `${disclaimer}<br><span style="color:#ff6b6b; font-weight:600;">‚ùå –®–Ü –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ (–ü–æ–º–∏–ª–∫–∞)</span>`;
    } else if (isPartialLoad) {
        el.innerHTML = `${disclaimer}<br><span style="color:#f0ad4e; font-weight:600;">‚ö†Ô∏è –û–±–º–µ–∂–µ–Ω–∏–π —Ä–µ–∂–∏–º (–í–Ω—É—Ç—Ä—ñ—à–Ω—è –±–∞–∑–∞)</span>`;
    } else if (pipe) {
        // Fully loaded
        el.innerHTML = disclaimer;
    } else {
        // Loading
        el.innerText = "–ó'—î–¥–Ω–∞–Ω–Ω—è...";
    }
}


// INIT EMBEDDINGS
async function initializeEmbeddings(){
    if (embeddingsLoading || pipe) return;
    
    embeddingsLoading=true;
    updateHeaderStatus();

    // 1. Load DB
    try {
        const response = await fetch('https://nd4s.github.io/science_knu_ua_new_files/ai_db.txt');
        if (!response.ok) throw new Error("Status: " + response.status);
        const text = await response.text();
        parseDatabase(text);
        
        let totalUrls = 0;
        for(let key in urlCategories) totalUrls += urlCategories[key].length;
        if (totalUrls === 0) throw new Error("Invalid Format");

        isPartialLoad = false;
    } catch (error) {
        console.warn("Ext DB failed, using internal.", error);
        parseDatabase(internalRawData);
        isPartialLoad = true; 
    }


    // 2. Load AI
    if(!pipe) {
        let progressMap = {};
        try {
            const {pipeline} = await import('https://cdn.jsdelivr.net/npm/@xenova/transformers@2.6.0');
            pipe = await pipeline('feature-extraction','Xenova/paraphrase-multilingual-MiniLM-L12-v2',{
                quantized:true,
                backend:'cpu',
                progress_callback: (p) => {
                    if (p.status === 'progress' && p.file) {
                        progressMap[p.file] = { loaded: p.loaded || 0, total: p.total || 0 };
                        let grandLoaded = 0, grandTotal = 0;
                        for (const file in progressMap) {
                            grandLoaded += progressMap[file].loaded;
                            grandTotal += progressMap[file].total;
                        }
                        const mb = (val) => (val / (1024 * 1024)).toFixed(1);
                        document.getElementById('headerStatus').innerText = `–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –®–Ü: ${mb(grandLoaded)}MB`;
                    }
                }
            });
            isCriticalError = false;
        } catch (e) {
            console.error(e);
            isCriticalError = true;
            updateHeaderStatus();
            embeddingsLoading=false;
            updateInputState();
            return;
        }
    }


    // 3. Set Final Header Status
    updateHeaderStatus();
    
    embeddingsLoading=false;
    
    // Enable UI
    const inputField = document.getElementById('inputText');
    const sendButton = document.querySelector('.send-button');
    sendButton.disabled = false;
    updateInputState();
    inputField.focus();
}


function openChat(){
    const chat=document.querySelector('.chat-container'),
          toggleButton=document.querySelector('.chat-toggle-button');
    chat.style.display='flex';
    toggleButton.style.display='none';
    
    if(!pipe && !embeddingsLoading) {
        initializeEmbeddings();
    }
}


document.querySelector('.chat-toggle-button').addEventListener('click', openChat);


document.querySelector('.close-chat-button').addEventListener('click',()=>{
    const chat=document.querySelector('.chat-container'),
          toggleButton=document.querySelector('.chat-toggle-button');
    chat.style.display='none';
    toggleButton.style.display='flex';
});


document.querySelectorAll(".chat-toggle-button").forEach(t=>{
    t.style.touchAction="manipulation";
    t.addEventListener("touchstart",e=>{t.style.transform="scale(0.95)";t.style.opacity="1";},{passive:true});
    t.addEventListener("touchend",e=>{t.style.transform="scale(1)";t.style.opacity="";},{passive:true});
});


document.getElementById('inputText').addEventListener('keypress',e=>{if(e.key==='Enter')sendMessage();});


async function getEmbedding(text){
    if(!pipe) throw new Error("Model not initialized");
    const output=await pipe(text,{pooling:'mean',normalize:true});
    return Array.from(output.data);
}


function cosineSimilarity(a,b){
    const dot=a.reduce((sum,val,i)=>sum+val*b[i],0),
          magA=Math.sqrt(a.reduce((sum,val)=>sum+val*val,0)),
          magB=Math.sqrt(b.reduce((sum,val)=>sum+val*val,0));
    return dot/(magA*magB);
}


function calculatePauseDuration(inputText){
    return Math.min((inputText.length/15)*1000,3000);
}


function checkForSevenChars(inputText){
    const sequenceRegex=/(.)\1{6}/,sequenceMatch=inputText.match(sequenceRegex);
    if(sequenceMatch) return sequenceMatch[0];
    if(inputText.length>=7){
        let bestMatch=null, maxLength=0;
        for(const answer of answers){
            let longestMatch='';
            for(let i=0;i<inputText.length;i++){
                for(let j=0;j<answer.length;j++){
                    let k=0;
                    while(i+k<inputText.length&&j+k<answer.length&&inputText[i+k]===answer[j+k]){
                        longestMatch+=inputText[i+k];k++;
                    }
                    if(longestMatch.length>=7&&longestMatch.length>maxLength){
                        maxLength=longestMatch.length;bestMatch=answer;
                    }
                    longestMatch='';
                }
            }
        }
        return bestMatch;
    }
    return null;
}


async function findBestMatch(inputText){
    if(isCriticalError || !pipe) {
        addBotMessage("–í–∏–±–∞—á—Ç–µ, –∞–ª–µ —á–µ—Ä–µ–∑ —Ç–µ—Ö–Ω—ñ—á–Ω–∏–π –∑–±—ñ–π —Å–∏—Å—Ç–µ–º–∞ –®–Ü –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –°–ø—Ä–æ–±—É–π—Ç–µ –æ–Ω–æ–≤–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É.");
        return;
    }


    let responseText = "";
    const directMatch = checkForSevenChars(inputText);
    
    if(directMatch) {
        await new Promise(resolve=>setTimeout(resolve,calculatePauseDuration(inputText)));
        responseText = directMatch;
    } else {
        const loader=document.createElement('div');
        loader.className='loader';
        const loadingMessage=document.createElement('div');
        loadingMessage.classList.add('message','bot');
        loadingMessage.innerHTML=`<div class="message-text"></div>`;
        loadingMessage.querySelector('.message-text').appendChild(loader);
        document.getElementById('chatHistory').appendChild(loadingMessage);
        
        try {
            const inputEmbedding = await getEmbedding(inputText);
            
            // Branch A: General
            let bestGenScore = -1, bestGenAnswer = '';
            for(const answer of answers){
                const score = cosineSimilarity(inputEmbedding, await getEmbedding(answer));
                if(score > bestGenScore){ bestGenScore = score; bestGenAnswer = answer; }
            }


            // Branch B: Categories
            let bestCategoryKey = null, bestCategoryScore = -1;
            for(const key in categoryDescriptors) {
                if(urlCategories[key].length === 0) continue;
                const score = cosineSimilarity(inputEmbedding, await getEmbedding(categoryDescriptors[key]));
                if(score > bestCategoryScore) { bestCategoryScore = score; bestCategoryKey = key; }
            }


            let bestUrlScore = -1, bestUrlEntry = null;
            
            // STRICT SEARCH: ONLY within the identified category
            if(bestCategoryKey) {
                for(const entry of urlCategories[bestCategoryKey]) {
                    const score = cosineSimilarity(inputEmbedding, await getEmbedding(entry.text));
                    if(score > bestUrlScore) { bestUrlScore = score; bestUrlEntry = entry; }
                }
            }


            const GEN_THRESHOLD = 0.25, URL_THRESHOLD = 0.35; 


            if(bestUrlScore > bestGenScore && bestUrlScore > URL_THRESHOLD && bestUrlEntry) {
                const catName = categoryDisplayNames[bestCategoryKey] || bestCategoryKey;
                responseText = `(üîç –ü–æ—à—É–∫ —É –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó: ${catName})<br><br>–í–∏ –º–æ–∂–µ—Ç–µ –∑–Ω–∞–π—Ç–∏ —Ü—é —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –∑–∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º: ${bestUrlEntry.url} . –ë–∞–∂–∞—î—Ç–µ, —â–æ–± —è –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏–≤ –í–∞—Å —Ç—É–¥–∏?`;
            } else if (bestGenScore > GEN_THRESHOLD) {
                responseText = bestGenAnswer;
            } else {
                responseText = "–ü–µ—Ä–µ–ø—Ä–æ—à—É—é, —è –Ω–µ –∑–Ω–∞—é –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∞–±–æ –Ω–µ –∑—Ä–æ–∑—É–º—ñ–≤ –ø–∏—Ç–∞–Ω–Ω—è";
            }
            
            await new Promise(resolve=>setTimeout(resolve,calculatePauseDuration(inputText)));
            
        } catch(error){
            console.error(error);
            responseText = `–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞: ${error.message}`;
        } finally {
            loadingMessage.remove();
        }
    }


    addBotMessage(responseText);
}


function addUserMessage(text){
    const chatHistory=document.getElementById('chatHistory'),
          message=document.createElement('div');
    message.classList.add('message','user');
    message.innerHTML=`<div class="message-text">${text}</div>`;
    chatHistory.appendChild(message);
    chatHistory.scrollTop=chatHistory.scrollHeight;
}


function linkify(text) {
    let replacedText = text.replace(/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;\u0400-\u052F]*[-A-Z0-9+&@#\/%=~_|\u0400-\u052F])/gim, '<a href="$1" target="_blank">$1</a>');
    replacedText = replacedText.replace(/(^|[^\/])(www\.[\S]+(\b|$))/gim, '$1<a href="http://$2" target="_blank">$2</a>');
    replacedText = replacedText.replace(/([\w\.\-]+@([\w\-]+\.)+[\w\-]{2,4})/gim, '<a href="mailto:$1">$1</a>');
    replacedText = replacedText.replace(/(\+[\d\s\-\(\)]{7,}\d)/g, function(match) {
        let cleanPhone = match.replace(/[^\d+]/g, '');
        return '<a href="tel:' + cleanPhone + '">' + match + '</a>';
    });
    return replacedText;
}


function addBotMessage(text){
    const chatHistory=document.getElementById('chatHistory'),
          message=document.createElement('div');
    message.classList.add('message','bot');
    message.innerHTML=`<div class="message-text"></div>`;
    chatHistory.appendChild(message);
    
    let index=0;
    const interval=setInterval(()=>{
        if(index<text.length){
            message.querySelector('.message-text').textContent+=text[index];
            index++;
        }else{
            clearInterval(interval);
            
            const messageTextElem = message.querySelector('.message-text');
            messageTextElem.innerHTML = linkify(messageTextElem.textContent);


            const inputField=document.getElementById('inputText'),
                  sendButton=document.querySelector('.send-button');
            inputField.disabled=false;
            sendButton.disabled=false;
            isProcessing=false;
            inputField.placeholder=inputField.getAttribute('data-placeholder');
            updateInputState();
            inputField.focus();


            const links = Array.from(messageTextElem.querySelectorAll('a'));
            
            // QR Wrapper
            let qrWrapper = null;
            if (links.length > 0) {
                qrWrapper = document.createElement('div');
                qrWrapper.className = 'qr-wrapper';
                const qrDisplay = document.createElement('div');
                qrDisplay.className = 'qr-display';
                qrWrapper.appendChild(qrDisplay);


                const qrControls = document.createElement('div');
                qrControls.className = 'qr-controls';
                
                const prevBtn = document.createElement('button');
                prevBtn.className = 'qr-nav-btn';
                prevBtn.innerHTML = '<i data-lucide="chevron-left" style="width:14px;height:14px;"></i>';
                
                const counter = document.createElement('span');
                counter.className = 'qr-counter';
                counter.innerText = `1 / ${links.length}`;
                
                const nextBtn = document.createElement('button');
                nextBtn.className = 'qr-nav-btn';
                nextBtn.innerHTML = '<i data-lucide="chevron-right" style="width:14px;height:14px;"></i>';


                if (links.length > 1) {
                    qrControls.appendChild(prevBtn);
                    qrControls.appendChild(counter);
                    qrControls.appendChild(nextBtn);
                    qrWrapper.appendChild(qrControls);
                }
                message.appendChild(qrWrapper);
                lucide.createIcons({ root: qrWrapper });
            }


            // Action Buttons
            const actionContainer = document.createElement('div');
            actionContainer.className = 'message-actions';
            
            const copyBtn = document.createElement('button');
            copyBtn.className = 'action-button';
            copyBtn.title = "–ö–æ–ø—ñ—é–≤–∞—Ç–∏"; 
            copyBtn.innerHTML = `<i data-lucide="copy"></i><span class="action-text">–ö–æ–ø—ñ—é–≤–∞—Ç–∏</span>`;
            actionContainer.appendChild(copyBtn);


            let qrBtn = null;
            let currentQrIndex = 0;
            if (links.length > 0) {
                qrBtn = document.createElement('button');
                qrBtn.className = 'action-button';
                qrBtn.title = "–ü–æ–∫–∞–∑–∞—Ç–∏ QR";
                qrBtn.innerHTML = `<i data-lucide="qr-code"></i><span class="action-text">QR-–∫–æ–¥</span>`;
                actionContainer.appendChild(qrBtn);
            }
            message.appendChild(actionContainer);
            lucide.createIcons({ root: actionContainer });
            setTimeout(() => actionContainer.style.opacity = '1', 100);


            copyBtn.addEventListener('click', () => {
                const textToCopy = text + "\n\n*–®–Ü –º–æ–∂–µ –ø–æ–º–∏–ª—è—Ç–∏—Å—è.*";
                navigator.clipboard.writeText(textToCopy).then(() => {
                    copyBtn.innerHTML = `<i data-lucide="check"></i><span class="action-text" style="color: #4caf50;">–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ</span>`;
                    lucide.createIcons({ root: copyBtn });
                    setTimeout(() => {
                        copyBtn.innerHTML = `<i data-lucide="copy"></i><span class="action-text">–ö–æ–ø—ñ—é–≤–∞—Ç–∏</span>`;
                        lucide.createIcons({ root: copyBtn });
                    }, 2000);
                });
            });


            if (qrBtn && qrWrapper) {
                const qrDisplayDiv = qrWrapper.querySelector('.qr-display');
                const prevBtn = qrWrapper.querySelector('.qr-nav-btn:first-child');
                const nextBtn = qrWrapper.querySelector('.qr-nav-btn:last-child');
                const counterText = qrWrapper.querySelector('.qr-counter');


                const updateQr = () => {
                    qrDisplayDiv.innerHTML = '';
                    links.forEach(l => l.classList.remove('qr-highlight'));
                    const activeLink = links[currentQrIndex];
                    activeLink.classList.add('qr-highlight');
                    new QRCode(qrDisplayDiv, { text: activeLink.href, width: 128, height: 128, colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.H });
                    if(links.length > 1) {
                        counterText.innerText = `${currentQrIndex + 1} / ${links.length}`;
                        prevBtn.disabled = currentQrIndex === 0;
                        nextBtn.disabled = currentQrIndex === links.length - 1;
                    }
                };
                qrBtn.addEventListener('click', () => {
                    const isHidden = window.getComputedStyle(qrWrapper).display === 'none';
                    if (isHidden) { qrWrapper.style.display = 'flex'; updateQr(); chatHistory.scrollTop = chatHistory.scrollHeight; } 
                    else { qrWrapper.style.display = 'none'; links.forEach(l => l.classList.remove('qr-highlight')); }
                });
                if (links.length > 1) {
                    prevBtn.addEventListener('click', () => { if (currentQrIndex > 0) { currentQrIndex--; updateQr(); } });
                    nextBtn.addEventListener('click', () => { if (currentQrIndex < links.length - 1) { currentQrIndex++; updateQr(); } });
                }
            }


            // Redirect Check
            let foundTriggerUrl = null;
            const allUrls = [];
            for(let k in urlCategories) urlCategories[k].forEach(u => allUrls.push(u.url));
            for(const u of allUrls) { if(text.includes(u)) { foundTriggerUrl = u; break; } }


            if(foundTriggerUrl) {
                const redirectDiv = document.createElement('div');
                redirectDiv.className = 'redirect-container';
                const yesBtn = document.createElement('button'); yesBtn.className = 'redirect-btn yes-btn'; yesBtn.innerText = "–¢–∞–∫"; yesBtn.onclick = () => window.location.href = foundTriggerUrl;
                const noBtn = document.createElement('button'); noBtn.className = 'redirect-btn no-btn'; noBtn.innerText = "–ù—ñ"; noBtn.onclick = () => { redirectDiv.style.opacity = '0'; setTimeout(() => redirectDiv.remove(), 300); };
                redirectDiv.appendChild(yesBtn); redirectDiv.appendChild(noBtn);
                message.appendChild(redirectDiv); setTimeout(() => redirectDiv.style.opacity = '1', 150);
            }
            chatHistory.scrollTop=chatHistory.scrollHeight; 
        }
    },50);
    chatHistory.scrollTop=chatHistory.scrollHeight;
}


async function sendMessage(){
    if(isProcessing)return;
    const inputText=document.getElementById('inputText').value.trim();
    if(!inputText)return;


    // DEBUG
    if(inputText === '#–ü–ï–†–ï–í–Ü–†–ö–ê_–ë–ê–ó–ò_–î–ê–ù–ò–•') {
        if(!pipe) await initializeEmbeddings();
        parseDatabase(internalRawData);
        isPartialLoad = true;
        updateHeaderStatus();
        document.getElementById('inputText').value='';
        return;
    }
    if(inputText === '#–ü–ï–†–ï–í–Ü–†–ö–ê_–ï–ú–ë–ï–î–î–Ü–ù–ì–Ü–í') {
        pipe = null; isCriticalError = true;
        updateHeaderStatus();
        document.getElementById('inputText').value='';
        updateInputState();
        return;
    }
    
    const inputField=document.getElementById('inputText'), sendButton=document.querySelector('.send-button');
    inputField.disabled=true; sendButton.disabled=true; isProcessing=true;
    inputField.setAttribute('data-placeholder',inputField.placeholder); inputField.placeholder='';
    
    addUserMessage(inputText);
    document.getElementById('inputText').value='';
    
    try{ await findBestMatch(inputText); } catch(error){ console.error(error); addBotMessage(`Error: ${error.message}`); }
}
</script>
</body>
</html>
